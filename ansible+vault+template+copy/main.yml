---

- hosts: 127.0.0.1
  become: false
  tasks:
    - vars:
        kek: kek
        lel: lel
        names:
          - 00-kek
          - 01-lel

      always:
        - &cleanup
          set_fact:
            rendered: []
          #no_log: true

      block:
        - *cleanup

        - set_fact:
            rendered: >-
              {{ rendered + [lookup('template', item ~ '.yml.j2')] }}
          loop: >-
            {{ names }}
          #no_log: true

        - shell: |
            set -o errexit -o pipefail
            ansible-vault encrypt_string | sed '/^!vault/d' \
                                         | tr -d '[:blank:]' \
                                         > encrypted.yml
          args:
            executable: bash
            stdin: >-
              {{ rendered | join }}
          environment:
            ANSIBLE_VAULT_PASSWORD_FILE: "{{ playbook_dir }}/vault-password-file"
          #no_log: true

        - shell: |
            # kubectl apply -f-
            cat
          args:
            stdin: >-
              {{ rendered | join }}

# vim:ts=2:sw=2:et:syn=yaml:
